# Story 6.2: Restauração de Funcionalidades Críticas e UX

## Status
Approved

## Story
**As a** usuário do sistema EngFlow,
**I want** que todas as funcionalidades críticas perdidas durante a migração sejam restauradas com interface responsiva e funcional,
**so that** eu possa operar o sistema com a mesma eficiência e experiência do sistema anterior.

## Acceptance Criteria

1. **Carrinho de compras em Requisições restaurado**:
   - Interface de adição de produtos/itens com quantidade em Nova Requisição
   - CRUD completo para itens do carrinho: adicionar, editar quantidade, remover itens
   - Persistência dos itens no banco de dados (campo `itens_produtos` JSONB)
   - Visualização clara dos itens adicionados na requisição

2. **Seleção de produtos em Nova Despesa funcional**:
   - Lista de produtos/itens da requisição selecionada visível
   - Checkbox/toggle para marcar produtos como comprados
   - Interface clara para escolher quais produtos da requisição estão sendo pagos
   - Atualização automática do status dos itens na requisição origem

3. **Interface responsiva verdadeiramente funcional**:
   - Todos os formulários se ajustam perfeitamente em qualquer resolução
   - Botões de ação (Cadastrar, Cancelar, Atualizar) sempre visíveis sem necessidade de zoom
   - Barras de rolagem aparecem automaticamente quando necessário
   - Formulários longos (como cadastro de obras com etapas) são navegáveis
   - Layout adaptativo em mobile, tablet e desktop

4. **UX profissional e moderna**:
   - Interface com vida, não apenas funcional
   - Espaçamentos adequados e hierarquia visual clara
   - Feedback visual para ações do usuário
   - Consistência visual em todos os módulos
   - Performance fluida em todas as interações

5. **Funcionalidades originais preservadas**:
   - Todos os workflows que funcionavam no localStorage devem funcionar idênticamente
   - Relacionamentos entre entidades mantidos
   - Capacidade de operação offline/fallback funcionando
   - Integridade dos dados preservada

## Tasks / Subtasks

- [x] **Restaurar Sistema de Carrinho em Requisições** (AC: 1)
  - [x] Criar componente CarrinhoItens para gestão de produtos/itens
  - [x] Implementar interface de adição de itens com campos nome, quantidade, descrição
  - [x] Adicionar CRUD completo: editar quantidade, remover items individuais
  - [x] Integrar com campo `itens_produtos` JSONB na tabela requisicoes
  - [x] Criar validações para garantir pelo menos 1 item por requisição
  - [x] Testar persistência e recuperação dos itens

- [ ] **Implementar Seleção de Produtos em Despesas** (AC: 2)
  - [ ] Criar componente SeletorProdutosRequisicao
  - [ ] Listar todos os itens da requisição selecionada com checkbox
  - [ ] Implementar toggle de seleção múltipla de produtos
  - [ ] Adicionar campo visual de quantidade e status (pendente/comprado)
  - [ ] Integrar com atualização do status dos itens na requisição origem
  - [ ] Validar que pelo menos 1 produto seja selecionado

- [ ] **Implementar Responsividade Verdadeira** (AC: 3)
  - [ ] Refazer sistema de CSS responsivo com breakpoints adequados
  - [ ] Implementar layout flexível para todos os formulários
  - [ ] Adicionar barras de rolagem automáticas em containers longos
  - [ ] Criar sistema de botões fixos/sticky para ações principais
  - [ ] Testar em resoluções 320px, 768px, 1024px, 1440px+
  - [ ] Implementar viewport meta tag adequada

- [ ] **Melhorar UX e Interface Visual** (AC: 4)
  - [ ] Revisar espaçamentos e paddings em todos os componentes
  - [ ] Implementar feedback visual para ações (loading, success, error)
  - [ ] Adicionar animações suaves para transições
  - [ ] Padronizar hierarquia tipográfica
  - [ ] Implementar sistema de cores consistente
  - [ ] Adicionar skeleton loading para operações assíncronas

- [ ] **Validar Funcionalidades Originais** (AC: 5)
  - [ ] Testar todos os workflows críticos end-to-end
  - [ ] Validar relacionamentos entre requisições-despesas-obras
  - [ ] Testar fallback para localStorage em caso de falha Supabase
  - [ ] Verificar integridade dos dados em todas as operações
  - [ ] Executar testes de regressão completos

## Dev Notes

### Informações Técnicas Relevantes

**Context da Story Anterior 6.1** [Source: docs/stories/6.1.story.md#dev-agent-record]:
- Implementação anterior focou em correção de erros básicos mas removeu funcionalidades críticas
- Campo `itens_produtos` foi adicionado à tabela requisicoes mas não tem interface funcional
- Integração requisições-despesas foi implementada mas sem UI para seleção de produtos
- CSS responsivo básico aplicado mas não resolve problemas de viewport

**Arquitetura de Dados** [Source: docs/architecture.md#database-schema]:
- Tabela `requisicoes` tem campo `itens_produtos` JSONB para armazenar carrinho
- Relacionamento requisicoes -> despesas via `requisicao_id`
- Estrutura de dados deve suportar: `[{nome: string, quantidade: number, descricao?: string, status: 'pendente'|'comprado'}]`

**Frontend Architecture** [Source: docs/architecture.md#frontend-architecture]:
- React 18.3.1 + TypeScript + shadcn-ui estabelecido
- React Hook Form + Zod para validação de formulários
- React Query para cache e sincronização
- Tailwind CSS para styling responsivo

**Estrutura Existente** [Source: 6.1 story implementation]:
- `src/pages/Requisicoes.tsx` - Módulo principal que precisa do carrinho
- `src/pages/Financeiro.tsx` - Módulo que precisa da seleção de produtos
- `src/styles/responsive.css` - CSS básico que precisa ser expandido

### Arquivos Críticos a Modificar

**Frontend (src/)**:
- `pages/Requisicoes.tsx` - Adicionar interface de carrinho de itens
- `pages/Financeiro.tsx` - Implementar seleção visual de produtos da requisição
- `components/forms/CarrinhoItens.tsx` - CRIAR componente de gestão de carrinho
- `components/forms/SeletorProdutos.tsx` - CRIAR componente de seleção de produtos
- `styles/responsive.css` - Expandir para responsividade verdadeira
- `styles/ux-improvements.css` - CRIAR para melhorias de UX

**Schemas e Validação**:
- Esquemas Zod para validação de itens do carrinho
- Validação de produtos selecionados em despesas
- Types TypeScript para estruturas de dados

### Testing

**Testing Standards** [Source: docs/architecture.md#testing-strategy]:
- Frontend: Vitest + Testing Library + React Query testing utils
- Testes de integração para workflows carrinho → seleção de produtos
- Testes de responsividade com diferentes viewports
- Testes E2E para workflows completos usuário

**Test Files Required**:
- `src/__tests__/components/CarrinhoItens.test.tsx`
- `src/__tests__/components/SeletorProdutos.test.tsx`
- `src/__tests__/integration/carrinho-requisicao-despesa.test.tsx`
- `src/__tests__/responsive/viewport-responsiveness.test.tsx`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 04/11/2025 | v1.0 | Story criada para restauração de funcionalidades críticas perdidas | Scrum Master |

## Dev Agent Record

*[Esta seção será preenchida pelo agente de desenvolvimento durante a implementação]*

### Agent Model Used
*[A ser preenchido pelo dev agent]*

### Debug Log References
*[A ser preenchido pelo dev agent]*

### Completion Notes List
*[A ser preenchido pelo dev agent]*

### File List
*[A ser preenchido pelo dev agent]*

## QA Results

*[Esta seção será preenchida pelo agente de QA após a implementação]*