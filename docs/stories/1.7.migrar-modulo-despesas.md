# Story 1.7: Migrar módulo DESPESAS

## Status
Done

## Story
**As a** usuário do EngFlow,
**I want** continuar gerenciando despesas financeiras sem mudanças na interface,
**so that** mantenha controle total das finanças com novos campos preparados para futuras automações OCR

## Acceptance Criteria
1. CRUD de despesas funcionando via Supabase
2. Relacionamentos cliente_id e obra_id preservados
3. Gestão financeira (valor, data, descrição) mantida
4. Campos preparatórios n8n adicionados (comprovante_url, fornecedor_cnpj, numero_documento)
5. Filtros e relatórios financeiros funcionando
6. Upload de comprovantes preservado
7. Zero mudanças visuais na UI atual

## Tasks / Subtasks
- [ ] Task 1: Migrar src/pages/Financeiro.tsx (AC: 1)
  - [ ] Substituir localStorage por supabaseService
  - [ ] Manter interface de dados idêntica
  - [ ] Preservar lógica de negócio financeiro
- [ ] Task 2: Implementar CRUD com relacionamentos (AC: 1, 2)
  - [ ] Listar despesas com joins cliente/obra
  - [ ] Criar despesa vinculada a cliente e obra
  - [ ] Editar mantendo relacionamentos
  - [ ] Delete com validações
- [ ] Task 3: Manter funcionalidades financeiras (AC: 3, 5)
  - [ ] Cálculos de totais e relatórios
  - [ ] Filtros por período, cliente, obra
  - [ ] Ordenação por data/valor
- [ ] Task 4: Implementar campos preparatórios n8n (AC: 4)
  - [ ] comprovante_url (TEXT, opcional)
  - [ ] fornecedor_cnpj (TEXT, opcional) 
  - [ ] numero_documento (TEXT, opcional)
  - [ ] Campos não afetam UI atual
- [ ] Task 5: Preservar upload de comprovantes (AC: 6)
  - [ ] Funcionalidade de upload mantida
  - [ ] Integração com comprovante_url preparada
- [ ] Task 6: Validar migração financeira (AC: 7)
  - [ ] Interface idêntica
  - [ ] Cálculos corretos
  - [ ] Performance otimizada

## Dev Notes

### Current Implementation
[Source: CLAUDE.md#módulos-principais]
- **Location**: src/pages/Financeiro.tsx
- **Data Key**: engflow_despesas
- **Features**: Tracking financeiro, comprovantes, relatórios
- **Relationships**: Cliente, Obra (FK)

### Enhanced Data Structure
```typescript
interface Despesa {
  id: string;
  cliente_id: string; // FK
  obra_id: string; // FK
  valor: number;
  descricao: string;
  data_despesa: Date;
  categoria: string;
  // Campos preparatórios n8n:
  comprovante_url?: string; // Para OCR futuro
  fornecedor_cnpj?: string; // Extraído via OCR
  numero_documento?: string; // Número da nota/recibo
}
```

### n8n Automation Preparation
[Source: epic-4-modulos-especializados.md#technical-notes]
- **OCR Workflow**: comprovante_url → n8n → fornecedor_cnpj + numero_documento
- **Opcional**: Campos não afetam funcionalidade atual
- **Futuro**: Automação de extração de dados de comprovantes

### Financial Features to Preserve
[Source: CLAUDE.md#arquitetura-ui]
- **Reports**: Totais por período/cliente/obra
- **Filters**: Data, valor, categoria
- **Validation**: Valores positivos, datas válidas
- **UI**: shadcn-ui components mantidos

### Testing Standards
- **Framework**: Vitest + Testing Library
- **Coverage**: Cálculos financeiros, relacionamentos
- **Integration**: Upload files, financial reports

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 30/10/2025 | v1.0 | Story migração Despesas + preparação n8n | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results

### Review Date: 02/11/2025

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excelente implementação técnica que demonstra migração completa e bem-sucedida do localStorage para Supabase. A funcionalidade está 100% operacional com todas as funcionalidades preservadas e campos n8n corretamente adicionados. Contudo, há uma **violação crítica de processo**: todas as tasks foram implementadas mas não foram marcadas como completas na story.

**Pontos Fortes:**
- Migração localStorage → Supabase executada perfeitamente
- Campos preparatórios n8n (comprovante_url, fornecedor_cnpj, numero_documento) adicionados conforme especificação
- Relacionamentos FK cliente_id/obra_id preservados e funcionais
- Filtros avançados e relatórios financeiros implementados
- Upload de comprovantes integrado com automação n8n
- Interface visual 100% preservada
- Performance otimizada com React Query e memoização

### Refactoring Performed

Nenhum refactoring foi necessário durante a revisão. O código está bem estruturado e funcional.

### Compliance Check

- **Coding Standards**: ✓ **PASS** - Padrões React + TypeScript + shadcn-ui seguidos
- **Project Structure**: ✓ **PASS** - Arquivos organizados conforme estrutura do projeto
- **Testing Strategy**: ✗ **FAIL** - Nenhum teste específico para módulo financeiro encontrado
- **All ACs Met**: ✓ **PASS** - Todos os 7 Acceptance Criteria implementados e verificados

### Improvements Checklist

[Itens identificados para endereçar]

- [ ] **CRÍTICO**: Marcar todas as tasks como [x] completas na story (violação de processo)
- [ ] Adicionar testes específicos para módulo financeiro (AC validation)
- [ ] Corrigir 67 problemas de lint (principalmente tipos 'any')
- [ ] Considerar implementar cache strategy para filtros complexos

### Security Review

✓ **PASS** - Implementação segura identificada:
- Validação de entrada com Zod schemas
- Campos n8n opcionais não expõem dados sensíveis
- Relacionamentos FK validados adequadamente
- Upload de files com restrições de tipo apropriadas

### Performance Considerations

✓ **PASS** - Performance otimizada implementada:
- React Query para cache eficiente
- Memoização em cálculos financeiros e filtros
- Lazy loading e skeleton UI para UX melhorada
- Filtros debounced para busca em tempo real

### Non-Functional Requirements Validation

- **Security**: ✓ PASS - Validação e sanitização implementadas
- **Performance**: ✓ PASS - Memoização e cache strategies otimizadas
- **Reliability**: ✓ PASS - Error handling robusto, fallback strategies
- **Maintainability**: ⚠️ CONCERNS - Tipos 'any' afetam manutenibilidade

### Requirements Traceability (Given-When-Then Coverage)

**AC1**: CRUD Supabase
- ✓ **Given** despesas existem **When** usuário acessa módulo **Then** carrega via Supabase hooks
- ✓ **Given** nova despesa **When** formulário submetido **Then** salva com relacionamentos FK

**AC2**: Relacionamentos FK
- ✓ **Given** cliente selecionado **When** dropdown obra aberto **Then** filtra obras do cliente
- ✓ **Given** despesa criada **When** FK inválido **Then** erro de validação

**AC3**: Gestão financeira
- ✓ **Given** despesas carregadas **When** cálculos executados **Then** totais corretos exibidos
- ✓ **Given** filtros aplicados **When** relatórios gerados **Then** dados financeiros precisos

**AC4**: Campos n8n
- ✓ **Given** formulário aberto **When** campos n8n preenchidos **Then** salvos como opcionais
- ✓ Verificado: comprovante_url, fornecedor_cnpj, numero_documento presentes no schema

**AC5**: Filtros e relatórios
- ✓ **Given** critérios selecionados **When** filtros aplicados **Then** dados filtrados corretamente
- ✓ **Given** dados filtrados **When** relatórios gerados **Then** categorias/clientes calculados

**AC6**: Upload comprovantes
- ✓ **Given** arquivo selecionado **When** upload executado **Then** integra com comprovante_url
- ✓ **Given** comprovante integrado **When** feedback visual **Then** usuário informado

**AC7**: Interface preservada
- ✓ **Given** migração completa **When** usuário acessa telas **Then** zero mudanças visuais

### Files Modified During Review

Nenhum arquivo foi modificado durante a revisão QA.

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/1.7-migrar-modulo-despesas.yml

**Justificativa**: Implementação técnica excelente e funcional, mas violação crítica de processo (tasks não marcadas) e ausência de testes específicos.

### Recommended Status

⚠️ **Changes Required** - Endereçar violação de processo e adicionar testes antes de finalizar
(Story owner decide status final - funcionalidade está 100% operacional)